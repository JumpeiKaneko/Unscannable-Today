<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unscannable Today</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* MindARのUIを隠す */
        .mindar-ui-overlay, .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

        /* === ホーム画面（タイトル画面）のスタイル === */
        #home-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999; /* 最前面 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            cursor: pointer;
        }
        
        /* フェードアウト用クラス */
        #home-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .home-title {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            letter-spacing: 0.2em;
            color: #fff;
            margin-bottom: 20px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .home-subtitle {
            font-family: var(--font-system);
            font-size: 0.7rem;
            letter-spacing: 0.15em;
            color: #888;
            animation: blink 2s infinite;
        }

        /* === ホームボタンのスタイル === */
        #home-btn {
            position: absolute;
            top: 30px; right: 30px; /* 右上に配置 */
            width: 40px; height: 40px;
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            z-index: 200;
        }
        
        #home-btn:hover { background: rgba(255,255,255,0.1); }
        
        /* 四角いアイコン（Stop/Homeのメタファー） */
        .home-icon {
            width: 8px; height: 8px;
            background-color: #fff;
        }

    </style>
</head>
<body>

    <div id="home-screen">
        <h1 class="home-title">Unscannable Today</h1>
        <div class="home-subtitle">TAP TO START</div>
    </div>

    <div id="loader-overlay">
        <div class="loader-text">Initializing...</div>
    </div>

    <div id="ui-container">
        <header>
            <h1 class="title">Unscannable Today</h1>
            <div class="meta">Asymmetry of Gaze / MindAR Core</div>
        </header>

        <div id="home-btn">
            <div class="home-icon"></div>
        </div>

        <div class="focus-guide">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="center-cross"></div>
        </div>

        <footer>
            <div id="status-text">
                <span class="status-icon">●</span>
                <span id="instruction">Ready to Scan</span>
            </div>
            <div id="fragment-id"></div>
        </footer>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; uiLoading: no; uiScanning: no;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="sound1" src="audio1.mp3" preload="auto"></audio>
            <audio id="sound2" src="audio2.mp3" preload="auto"></audio>
            <audio id="sound3" src="audio3.mp3" preload="auto"></audio>
            <audio id="sound4" src="audio4.mp3" preload="auto"></audio>
            <audio id="sound5" src="audio5.mp3" preload="auto"></audio>
            <audio id="sound6" src="audio6.mp3" preload="auto"></audio>
            <audio id="sound7" src="audio7.mp3" preload="auto"></audio>
            <audio id="sound8" src="audio8.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" data-sound="sound1" data-id="01"></a-entity>
        <a-entity mindar-image-target="targetIndex: 1" data-sound="sound2" data-id="02"></a-entity>
        <a-entity mindar-image-target="targetIndex: 2" data-sound="sound3" data-id="03"></a-entity>
        <a-entity mindar-image-target="targetIndex: 3" data-sound="sound4" data-id="04"></a-entity>
        <a-entity mindar-image-target="targetIndex: 4" data-sound="sound5" data-id="05"></a-entity>
        <a-entity mindar-image-target="targetIndex: 5" data-sound="sound6" data-id="06"></a-entity>
        <a-entity mindar-image-target="targetIndex: 6" data-sound="sound7" data-id="07"></a-entity>
        <a-entity mindar-image-target="targetIndex: 7" data-sound="sound8" data-id="08"></a-entity>
    </a-scene>

    <script>
        const loader = document.querySelector('#loader-overlay');
        const homeScreen = document.querySelector('#home-screen');
        const homeBtn = document.querySelector('#home-btn');
        
        const instruction = document.querySelector('#instruction');
        const fragmentDisplay = document.querySelector('#fragment-id');
        const statusIcon = document.querySelector('.status-icon');
        const focusGuide = document.querySelector('.focus-guide');
        const scene = document.querySelector('a-scene');
        
        const targets = document.querySelectorAll('[mindar-image-target]');
        let currentAudio = null;

        // MindAR準備完了
        scene.addEventListener("arReady", (event) => {
            console.log("MindAR is ready");
            loader.classList.add('fade-out'); // ローダー消す
            // ホーム画面はまだ残る（タップ待ち）
        });

        // ■ ホーム画面のタップ開始処理
        homeScreen.addEventListener('click', () => {
            // ホーム画面を消す
            homeScreen.classList.add('hidden');
            instruction.innerHTML = "Scanning...";
            
            // iOSの音声再生制限解除のためのダミー再生
            if (targets.length > 0) {
                const s = document.querySelector('#' + targets[0].getAttribute('data-sound'));
                if(s) {
                    s.play().then(() => s.pause()).catch(() => {});
                }
            }
        });

        // ■ ホームボタンの処理
        homeBtn.addEventListener('click', () => {
            // ホーム画面を戻す
            homeScreen.classList.remove('hidden');
            
            // 再生中の音を止める
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            // UIリセット
            statusIcon.classList.remove('active');
            focusGuide.classList.remove('locked');
            fragmentDisplay.innerHTML = "";
            instruction.innerHTML = "Ready to Scan";
        });

        // ARターゲット処理
        targets.forEach((target) => {
            target.addEventListener('targetFound', () => {
                // ホーム画面が出ている時は反応させない
                if (!homeScreen.classList.contains('hidden')) return;

                const soundId = target.getAttribute('data-sound');
                const fragmentId = target.getAttribute('data-id');
                const sound = document.querySelector('#' + soundId);

                instruction.innerHTML = "Acquired.";
                fragmentDisplay.innerHTML = `NARRATIVE_FRAGMENT_${fragmentId}`;
                statusIcon.classList.add('active');
                focusGuide.classList.add('locked');

                if (currentAudio && currentAudio !== sound) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                sound.play();
                currentAudio = sound;
            });

            target.addEventListener('targetLost', () => {
                const soundId = target.getAttribute('data-sound');
                const sound = document.querySelector('#' + soundId);
                
                if(sound) sound.pause();

                if (currentAudio === sound) {
                    instruction.innerHTML = "Scanning...";
                    fragmentDisplay.innerHTML = "";
                    statusIcon.classList.remove('active');
                    focusGuide.classList.remove('locked');
                    currentAudio = null;
                }
            });
        });
    </script>
</body>
</html>
