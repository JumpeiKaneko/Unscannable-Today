<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unscannable Today</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* MindARのデフォルトUI（Scanning...などのオーバーレイ）を消す */
        .mindar-ui-overlay { display: none !important; }
        .mindar-ui-loading { display: none !important; }
        .mindar-ui-scanning { display: none !important; }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader-text">Initializing Neural Networks...</div>
    </div>

    <div id="ui-container">
        <header>
            <h1 class="title">Unscannable Today</h1>
            <div class="meta">Asymmetry of Gaze / MindAR Core</div>
        </header>

        <div class="focus-guide">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="center-cross"></div>
        </div>

        <footer>
            <div id="status-text">
                <span class="status-icon">●</span>
                <span id="instruction">Processing Visual Data...</span>
            </div>
            <div id="fragment-id"></div>
        </footer>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001; uiLoading: no; uiScanning: no;" 
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="sound1" src="audio1.mp3" preload="auto"></audio>
            <audio id="sound2" src="audio2.mp3" preload="auto"></audio>
            <audio id="sound3" src="audio3.mp3" preload="auto"></audio>
            <audio id="sound4" src="audio4.mp3" preload="auto"></audio>
            <audio id="sound5" src="audio5.mp3" preload="auto"></audio>
            <audio id="sound6" src="audio6.mp3" preload="auto"></audio>
            <audio id="sound7" src="audio7.mp3" preload="auto"></audio>
            <audio id="sound8" src="audio8.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" data-sound="sound1" data-id="01"></a-entity>
        <a-entity mindar-image-target="targetIndex: 1" data-sound="sound2" data-id="02"></a-entity>
        <a-entity mindar-image-target="targetIndex: 2" data-sound="sound3" data-id="03"></a-entity>
        <a-entity mindar-image-target="targetIndex: 3" data-sound="sound4" data-id="04"></a-entity>
        <a-entity mindar-image-target="targetIndex: 4" data-sound="sound5" data-id="05"></a-entity>
        <a-entity mindar-image-target="targetIndex: 5" data-sound="sound6" data-id="06"></a-entity>
        <a-entity mindar-image-target="targetIndex: 6" data-sound="sound7" data-id="07"></a-entity>
        <a-entity mindar-image-target="targetIndex: 7" data-sound="sound8" data-id="08"></a-entity>

    </a-scene>

    <script>
        const loader = document.querySelector('#loader-overlay');
        const instruction = document.querySelector('#instruction');
        const fragmentDisplay = document.querySelector('#fragment-id');
        const statusIcon = document.querySelector('.status-icon');
        const focusGuide = document.querySelector('.focus-guide');
        const scene = document.querySelector('a-scene');
        
        // MindARのターゲットエンティティをすべて取得
        const targets = document.querySelectorAll('[mindar-image-target]');
        let currentAudio = null;

        // MindARの準備完了イベント
        scene.addEventListener("arReady", (event) => {
            console.log("MindAR is ready");
            loader.classList.add('fade-out');
            instruction.innerHTML = "Scanning...";
        });

        // ロードエラー等のハンドリング
        scene.addEventListener("arError", (event) => {
            console.log("MindAR failed to start");
            instruction.innerHTML = "Camera Access Denied";
        });

        targets.forEach((target) => {
            
            // 認識成功 (Target Found)
            target.addEventListener('targetFound', () => {
                const soundId = target.getAttribute('data-sound');
                const fragmentId = target.getAttribute('data-id');
                const sound = document.querySelector('#' + soundId);

                console.log(`Target ${fragmentId} found`);

                // UI更新
                instruction.innerHTML = "Acquired.";
                fragmentDisplay.innerHTML = `NARRATIVE_FRAGMENT_${fragmentId}`;
                statusIcon.classList.add('active');
                focusGuide.classList.add('locked');

                // 音声切り替え
                if (currentAudio && currentAudio !== sound) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                // 再生
                sound.play().catch(e => {
                    console.log("Audio autoplay prevented", e);
                });
                currentAudio = sound;
            });

            // 認識ロスト (Target Lost)
            target.addEventListener('targetLost', () => {
                const soundId = target.getAttribute('data-sound');
                const sound = document.querySelector('#' + soundId);
                const fragmentId = target.getAttribute('data-id');
                
                console.log(`Target ${fragmentId} lost`);

                if(sound) {
                    sound.pause();
                }

                // UIリセット（少し遅延させても良いが、機械的に即座に切る）
                // MindARは複数認識の可能性があるため、他のターゲットが認識中かチェックするのは難しいが
                // 基本的に「ロストしたら切る」でOK
                
                // ただし、一瞬のチラつきでSearchingに戻るのを防ぐため、
                // 本当に何も認識していないか確認したいが、
                // MindARの仕様上、ここはシンプルに「ロストしたターゲットの音を止める」処理にする
                
                // もし「再生中の音」と「ロストした音」が同じなら、Searchingに戻す
                if (currentAudio === sound) {
                    instruction.innerHTML = "Scanning...";
                    fragmentDisplay.innerHTML = "";
                    statusIcon.classList.remove('active');
                    focusGuide.classList.remove('locked');
                    currentAudio = null;
                }
            });
        });
        
        // タップでオーディオコンテキスト有効化
        document.body.addEventListener('click', () => {
             // ダミー再生でロック解除
             if(currentAudio && currentAudio.paused) currentAudio.play();
        }, {once: true});

    </script>
</body>
</html>
